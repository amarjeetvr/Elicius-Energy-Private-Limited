services:
  # ── MySQL Database ─────────────────────────────────────
  db:
    image: mysql:8.0
    container_name: energy-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: energy_db
      MYSQL_USER: energy_user
      MYSQL_PASSWORD: energy_pass
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ── Mosquitto MQTT Broker ──────────────────────────────
  mqtt-broker:
    image: eclipse-mosquitto:2
    container_name: energy-mqtt
    restart: always
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf
      - mosquitto_data:/mosquitto/data
      - mosquitto_log:/mosquitto/log

  # ── Node-RED (MQTT Simulator / Flow Tool) ──────────────
  nodered:
    image: nodered/node-red:latest
    container_name: energy-nodered
    restart: always
    ports:
      - "1880:1880"
    volumes:
      - nodered_data:/data
    depends_on:
      - mqtt-broker

  # ── FastAPI Backend ────────────────────────────────────
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: energy-backend
    restart: always
    ports:
      - "8000:8000"
    environment:
      DATABASE_URL: mysql+pymysql://energy_user:energy_pass@db:3306/energy_db
      MQTT_BROKER_HOST: mqtt-broker
      MQTT_BROKER_PORT: 1883
    depends_on:
      db:
        condition: service_healthy
      mqtt-broker:
        condition: service_started

  # ── React Frontend ─────────────────────────────────────
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: energy-frontend
    restart: always
    ports:
      - "3000:80"
    depends_on:
      - backend

volumes:
  mysql_data:
  mosquitto_data:
  mosquitto_log:
  nodered_data:
